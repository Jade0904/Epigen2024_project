---
title: "4_Temporal_Binding_Dynamics"
author: "Zhihan Zhu"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_knit$set(root.dir = rprojroot::find_rstudio_root_file())
```

```{r}
# import useful packages
suppressPackageStartupMessages({
  library(AnnotationHub)
  library(epiwraps)
  library(GenomicRanges)
  library(rtracklayer)
  library(Rsubread)
  library(R.utils)
})
```

## Temporal Binding Dynamics

In the pairwise comparisons analysis, we found that most of the colocated binding sites are found in non-dynamic peaks. We inferred that, this is because most of the TF dynamics happen between time point 0 and 1, and thus these differential binding sites can not be significantly detected if we do the differential analysis between time point 1 and 12, and actually aggregated in non-significant group. In this chapter, we are going to compare the peaks at different time points to verify this statement.

```{r}
# import peaks, only use replicate 2 for consistency and simplicity

# GR
GR_t1 <- rtracklayer::import("data/peaks/GR_t1_rep2.bed.gz", format = "narrowPeak")
GR_t12 <- rtracklayer::import("data/peaks/GR_t12_rep2.bed.gz", format = "narrowPeak")

# JUN
JUN_t1 <- rtracklayer::import("data/peaks/JUN_t1_rep2.bed.gz", format = "narrowPeak")
JUN_t12 <- rtracklayer::import("data/peaks/JUN_t12_rep2.bed.gz", format = "narrowPeak")

# JUNB
JUNB_t1 <- rtracklayer::import("data/peaks/JUNB_t1_rep2.bed.gz", format = "narrowPeak")
JUNB_t12 <- rtracklayer::import("data/peaks/JUNB_t12_rep2.bed.gz", format = "narrowPeak")

# DNase
DNase_t1 <- rtracklayer::import("data/peaks/DNase_t1_rep2.bed.gz", format = "narrowPeak")
DNase_t12 <- rtracklayer::import("data/peaks/DNase_t12_rep2.bed.gz", format = "narrowPeak")
```

### use Upset plot to see the intersection

```{r}
# GR
suppressWarnings({
  GR_peaks <- list(GR_t1, GR_t12)
  names(GR_peaks) <- c("GR_t1", "GR_t12")
  regionUpset(GR_peaks)
})
```

```{r}
# JUN
suppressWarnings({
  JUN_peaks <- list(JUN_t1, JUN_t12)
  names(JUN_peaks) <- c("JUN_t1", "JUN_t12")
  regionUpset(JUN_peaks)
})
```

```{r}
# JUNB
suppressWarnings({
  JUNB_peaks <- list(JUNB_t1, JUNB_t12)
  names(JUNB_peaks) <- c("JUNB_t1", "JUNB_t12")
  regionUpset(JUNB_peaks)
})
```

It is true that most of the GR binding sites present at later time point (i.e. time point 12) were also present at early time point (i.e. time point 1). However, this is not true though, for JUN and JUNB. It is obvious that, for JUN and JUNB, the binding sites present at later time point are much more than that at early time point, and opposite to GR, nearly all of the JUN and JUNB binding sites present at early time point were also present at later time point.

So it's only true that GR dynamics happen between time point 0 and 1, but not the case for JUN and JUNB.

## Co-occurrence analysis

```{r}
# t1
suppressWarnings({
  t1_peaks <- list(GR_t1, JUN_t1, JUNB_t1)
  names(t1_peaks) <- c("GR_t1", "JUN_t1", "JUNB_t1")
  regionUpset(t1_peaks, set_size.show = TRUE)
})
```

```{r}
# t12
suppressWarnings({
  t12_peaks <- list(GR_t12, JUN_t12, JUNB_t12)
  names(t12_peaks) <- c("GR_t12", "JUN_t12", "JUNB_t12")
  regionUpset(t12_peaks, set_size.show = TRUE)
})
```

At the beginning of the treatment (time point 1), the co-occurrence of GR, JUN and JUNB happens quite often (4272 out of 8874 GR peaks). At late stage of the treatment (time point 12), the absolute number of co-occurrence peaks is decreasing, however it becomes the most part of GR peaks (3787 out of 3930 peaks). The co-occurrence of JUN and JUNB happens a lot at time point 12.

We are interested in, to what extent JUN/JUNB colocalize within the GR sites.

```{r}
# t1
JUN_GR_t1 <- intersect(JUN_t1, GR_t1)
JUNB_GR_t1 <- intersect(JUNB_t1, GR_t1)

print("At time point 1:")

JUN_t1_prop <- round(sum(overlapsAny(JUN_GR_t1, JUNB_GR_t1))/length(JUN_GR_t1), digits = 4) * 100
print(paste0("Of the JUN sites within GR sites, ", as.character(JUN_t1_prop), "% overlap JUNB sites within GR sites."))

JUNB_t1_prop <- round(sum(overlapsAny(JUNB_GR_t1, JUN_GR_t1))/length(JUNB_GR_t1), digits = 4) * 100
print(paste0("Of the JUNB sites within GR sites, ", as.character(JUNB_t1_prop), "% overlap JUN sites within GR sites."))
```

```{r}
# t12
JUN_GR_t12 <- intersect(JUN_t12, GR_t12)
JUNB_GR_t12 <- intersect(JUNB_t12, GR_t12)

print("At time point 12:")

suppressWarnings({
  JUN_t12_prop <- round(sum(overlapsAny(JUN_GR_t12, JUNB_GR_t12))/length(JUN_GR_t12), digits = 4) * 100
})
print(paste0("Of the JUN sites within GR sites, ", as.character(JUN_t12_prop), "% overlap JUNB sites within GR sites."))

suppressWarnings({
  JUNB_t12_prop <- round(sum(overlapsAny(JUNB_GR_t12, JUN_GR_t12))/length(JUNB_GR_t12), digits = 4) * 100
})
print(paste0("Of the JUNB sites within GR sites, ", as.character(JUNB_t12_prop), "% overlap JUN sites within GR sites."))
```

### differential accessibility between different groups of GR sites

Here we would like to separate GR sites into two groups: the ones that gain JUN/JUNB sites, and the ones do not. And we are interested in the GR sites that gain JUN/JUNB show more change in accessibility than that don't.

```{r}
# import GR peak sets at t1
GR_t1_peaks <- c("GR_t1_rep1.bed.gz", "GR_t1_rep2.bed.gz", "GR_t1_rep3.bed.gz")
GR_t1_peaks <- lapply(file.path("data/peaks", GR_t1_peaks), rtracklayer::import, format="narrowPeak")
GR_t1_peaks <- reduce(unlist(GRangesList(GR_t1_peaks)), with.revmap=TRUE)
# length(GR_t1_peaks) 11740

# import JUN/JUNB peak sets at t1
JUN_JUNB_t1_peaks <- c("JUN_t1_rep2.bed.gz", "JUN_t1_rep3.bed.gz", "JUNB_t1_rep2.bed.gz", "JUNB_t1_rep3.bed.gz")
JUN_JUNB_t1_peaks <- lapply(file.path("data/peaks", JUN_JUNB_t1_peaks), rtracklayer::import, format="narrowPeak")
JUN_JUNB_t1_peaks <- reduce(unlist(GRangesList(JUN_JUNB_t1_peaks)), with.revmap=TRUE)
# length(JUN_JUNB_t1_peaks) 35808

# subset GR peaks that do not have JUN/JUNB at t1
GR_t1_peaks <- subsetByOverlaps(GR_t1_peaks, JUN_JUNB_t1_peaks, invert = FALSE)
# length(GR_t1_peaks) 9495

# import GR peak sets at t12
GR_t12_peaks <- c("GR_t12_rep1.bed.gz", "GR_t12_rep2.bed.gz", "GR_t12_rep3.bed.gz")
GR_t12_peaks <- lapply(file.path("data/peaks", GR_t12_peaks), rtracklayer::import, format="narrowPeak")
GR_t12_peaks <- reduce(unlist(GRangesList(GR_t12_peaks)), with.revmap=TRUE)
# length(GR_t12_peaks) 5591

# import JUN/JUNB peak sets at t12
JUN_JUNB_t12_peaks <- c("JUN_t12_rep1.bed.gz", "JUN_t12_rep2.bed.gz", "JUN_t12_rep3.bed.gz", "JUNB_t12_rep1.bed.gz", "JUNB_t12_rep2.bed.gz")
JUN_JUNB_t12_peaks <- lapply(file.path("data/peaks", JUN_JUNB_t12_peaks), rtracklayer::import, format="narrowPeak")
JUN_JUNB_t12_peaks <- reduce(unlist(GRangesList(JUN_JUNB_t12_peaks)), with.revmap=TRUE)
# length(JUN_JUNB_t12_peaks) 67785

# subset GR peaks that have JUN/JUNB at t12
GR_t12_peaks_group1 <- subsetByOverlaps(GR_t12_peaks, JUN_JUNB_t12_peaks)
# length(GR_t12_peaks_group1) 5521
# subset GR peaks that do not have JUN/JUNB at t12
GR_t12_peaks_group2 <- subsetByOverlaps(GR_t12_peaks, JUN_JUNB_t12_peaks, invert = TRUE)
# length(GR_t12_peaks_group2) 70

# GR sites that gain JUN/JUNB at t12 (group 1)
GR_group1 <- subsetByOverlaps(GR_t1_peaks, GR_t12_peaks_group1)
# length(GR_group1) 4761
# GR sites that do not gain JUN/JUNB at t12 (group 2)
GR_group2 <- subsetByOverlaps(GR_t1_peaks, GR_t12_peaks_group2)
# length(GR_group2) 19

# import DNase peaks at t12
DNase_t12_peaks <- c("DNase_t12_rep1.bed.gz", "DNase_t12_rep2.bed.gz", "DNase_t12_rep3.bed.gz", "DNase_t12_rep5.bed.gz")
DNase_t12_peaks <- lapply(file.path("data/peaks", DNase_t12_peaks), rtracklayer::import, format="narrowPeak")
DNase_t12_peaks <- reduce(unlist(GRangesList(DNase_t12_peaks)), with.revmap=TRUE)

# subset GR sites that have accessibility at t12
GR_group1 <- subsetByOverlaps(GR_group1, DNase_t12_peaks)
# length(GR_group1) 4412
GR_group2 <- subsetByOverlaps(GR_group2, DNase_t12_peaks)
# length(GR_group2) 7
```

Basically, if we focus on two groups of GR sites, (1) the ones that do not have JUN/JUNB sites at t1 but gain JUN/JUNB at t12; (2) the ones that do not have JUN/JUNB sites at t1 and do not gain JUN/JUNB at t12, we can see that

